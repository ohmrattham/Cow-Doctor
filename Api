CHANNEL_API_KEY ="BbrDFMNe8lpGWTyVSX/NuMX4qeAUUyAbm68nXcWycnDcxy1wQVgn2Xikf1umD5OoHuGClyOHdHdtjgOpMoAy8UbKAqDYHgWG6B68EuI9IH0HJ2dStmdNBKBvPlIAi1XLR1il9bwShRi/e1uec5hJbQdB04t89/1O/w1cDnyilFU="
GEMINI_API_KEY = "AIzaSyCGE6OE51SXA44dlCU5yZhNNFaFzGt1rMg"


**************************************************************************************************************************************************************************************************************************

// Line Cow Disease Bot with Gemini + TeachableMachine
require("dotenv").config();
const express = require("express");
const axios = require("axios");
const fs = require("fs");
const tf = require("@tensorflow/tfjs");
const multer = require("multer");
const { createCanvas, loadImage } = require("canvas");

const app = express();
app.use(express.json());
const upload = multer({ dest: "uploads/" });
const CHANNEL_ACCESS_TOKEN = process.env.CHANNEL_API_KEY;
let model;

const userMemory = {}; // userId -> array of { role: "user" | "bot", text: string }
const lastImages = {}; // userId -> last image file path (for follow-up)

const classNames = [
  "à¹‚à¸£à¸„à¹„à¸‚à¹‰3à¸§à¸±à¸™",
  "à¹‚à¸£à¸„à¸›à¸²à¸à¹€à¸—à¹‰à¸²à¹€à¸›à¸·à¹ˆà¸­à¸¢",
  "à¹‚à¸£à¸„BlackLeg",
  "à¹‚à¸£à¸„à¸„à¸­à¸šà¸§à¸¡",
  "à¹‚à¸£à¸„à¹à¸­à¸™à¹à¸—à¸£à¸à¸‹à¹Œ",
  "à¹‚à¸£à¸„à¸¥à¸±à¸¡à¸›à¸µà¸ªà¸à¸´à¸™"
];

// à¸¥à¹‰à¸²à¸‡à¸„à¸§à¸²à¸¡à¸ˆà¸³à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸—à¸¸à¸ 5 à¸™à¸²à¸—à¸µ à¸žà¸£à¹‰à¸­à¸¡à¸¥à¸šà¹„à¸Ÿà¸¥à¹Œà¸ à¸²à¸ž
setInterval(() => {
  for (const userId in userMemory) {
    userMemory[userId] = [];
  }
  for (const userId in lastImages) {
    const filePath = lastImages[userId];
    if (fs.existsSync(filePath)) {
      fs.unlinkSync(filePath);
    }
    delete lastImages[userId];
  }
  console.log("ðŸ§¹ à¸¥à¹‰à¸²à¸‡à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸ªà¸™à¸—à¸™à¸²à¹à¸¥à¸°à¸¥à¸šà¸ à¸²à¸žà¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹à¸¥à¹‰à¸§");
}, 5 * 60 * 1000); // 5 à¸™à¸²à¸—à¸µ

// à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸ à¸²à¸žà¸ˆà¸²à¸ Teachable Machine
const loadModel = async () => {
  model = await tf.loadLayersModel(
    "https://teachablemachine.withgoogle.com/models/I_d2z8vuR/model.json"
  );
  console.log("âœ… Model loaded");
};
loadModel();

// à¹€à¸Šà¹‡à¸„à¸§à¹ˆà¸² webhook à¸—à¸³à¸‡à¸²à¸™à¸­à¸¢à¸¹à¹ˆ
app.get("/webhook", (req, res) => {
  res.send("âœ… Webhook is running");
});

// à¸£à¸±à¸š POST à¸ˆà¸²à¸ LINE
app.post("/webhook", async (req, res) => {
  const events = req.body.events;
  if (!events || !Array.isArray(events)) return res.sendStatus(200);

  for (const event of events) {
    const userId = event.source.userId;
    const replyToken = event.replyToken;
    const message = event.message;

    if (!userMemory[userId]) userMemory[userId] = [];

    if (message?.type === "image") {
      await reply(replyToken, "à¸à¸³à¸¥à¸±à¸‡à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸ à¸²à¸ž à¸à¸£à¸¸à¸“à¸²à¸£à¸­à¸ªà¸±à¸à¸„à¸£à¸¹à¹ˆ...");
      try {
        const messageId = message.id;
        const imgRes = await axios.get(
          `https://api-data.line.me/v2/bot/message/${messageId}/content`,
          {
            responseType: "arraybuffer",
            headers: { Authorization: `Bearer ${CHANNEL_ACCESS_TOKEN}` },
          }
        );

        const filePath = `uploads/${messageId}.jpg`;
        fs.writeFileSync(filePath, Buffer.from(imgRes.data));
        lastImages[userId] = filePath;

        const img = await loadImage(filePath);
        const canvas = createCanvas(224, 224);
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, 224, 224);
        const tensor = tf.browser.fromPixels(canvas).toFloat().div(255).expandDims(0);
        const prediction = model.predict(tensor);
        const result = await prediction.array();
        const scores = result[0];
        const maxScore = Math.max(...scores);
        const maxIndex = scores.indexOf(maxScore);

        const threshold = 0.7;
        if (maxScore >= threshold) {
          const disease = classNames[maxIndex];
          const prompt = `à¸‚à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¹‚à¸£à¸„ ${disease} à¹ƒà¸™à¸§à¸±à¸§ à¹‚à¸”à¸¢à¸ªà¸£à¸¸à¸›à¹€à¸›à¹‡à¸™à¸«à¸±à¸§à¸‚à¹‰à¸­à¸žà¸£à¹‰à¸­à¸¡à¸­à¸µà¹‚à¸¡à¸ˆà¸´à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸­à¸˜à¸´à¸šà¸²à¸¢à¸­à¸µà¹‚à¸¡à¸ˆà¸´`;
          const replyText = await askGemini(prompt);
          userMemory[userId].push({ role: "bot", text: replyText });
          if (userMemory[userId].length > 10) userMemory[userId].shift();
          await push(userId, `âœ… à¸•à¸£à¸§à¸ˆà¸žà¸šà¸§à¹ˆà¸²à¸­à¸²à¸ˆà¹€à¸›à¹‡à¸™: ${disease}\n\nðŸ“– ${replyText}`);
        } else {
          await push(userId, "à¸£à¸¹à¸›à¸ à¸²à¸žà¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸§à¸´à¸™à¸´à¸ˆà¸‰à¸±à¸¢à¹‚à¸£à¸„à¹„à¸”à¹‰à¸«à¸£à¸·à¸­à¸ªà¸²à¸¢à¸žà¸±à¸™à¸˜à¸¸à¹Œà¸‚à¸­à¸§à¸±à¸§à¹„à¸”à¹‰\nà¸à¸£à¸¸à¸“à¸²à¸žà¸´à¸¡à¸žà¹Œà¸­à¸²à¸à¸²à¸£à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¸«à¸£à¸·à¸­à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸£à¸¹à¸›à¸™à¸µà¹‰à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰ AI à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡");
        }
      } catch (err) {
        console.error("âŒ Image processing error:", err);
        await push(userId, "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸ à¸²à¸ž");
      }
    } else if (message?.type === "text") {
      userMemory[userId].push({ role: "user", text: message.text });
      if (userMemory[userId].length > 10) userMemory[userId].shift();

      if (lastImages[userId]) {
        const filePath = lastImages[userId];
        const prompt = `à¸ à¸²à¸žà¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸™à¸µà¹‰à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ: ${message.text}\nà¸Šà¹ˆà¸§à¸¢à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸£à¹ˆà¸§à¸¡à¸à¸±à¸™à¹à¸¥à¸°à¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¹‚à¸£à¸„à¸«à¸£à¸·à¸­à¸žà¸¤à¸•à¸´à¸à¸£à¸£à¸¡à¸—à¸²à¸‡à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´à¸—à¸µà¹ˆà¸­à¸²à¸ˆà¹€à¸›à¹‡à¸™`;
        const replyText = await askGeminiWithImage(filePath, prompt);
        delete lastImages[userId];
        if (fs.existsSync(filePath)) {
          fs.unlinkSync(filePath);
        }
        userMemory[userId].push({ role: "bot", text: replyText });
        await reply(replyToken, replyText);
      } else {
        const dialog = userMemory[userId]
          .slice(-10)
          .map((entry) => `${entry.role === "user" ? "à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰" : "AI"}: ${entry.text}`)
          .join("\n");

        const fullPrompt = `à¸•à¹ˆà¸­à¹„à¸›à¸™à¸µà¹‰à¸„à¸·à¸­à¸šà¸—à¸ªà¸™à¸—à¸™à¸²à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸à¸±à¸š AIà¸œà¸¸à¹‰à¸«à¸à¸´à¸‡à¸—à¸µà¹ˆà¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¹€à¸£à¸·à¹ˆà¸­à¸‡à¸§à¸±à¸§ à¹‚à¸”à¸¢à¸ˆà¸°à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸§à¸±à¸§à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ à¸«à¸²à¸à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸–à¸²à¸¡à¹„à¸¡à¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸§à¸±à¸§ à¸ˆà¸°à¸•à¸­à¸šà¸§à¹ˆà¸² à¸‚à¸­à¹‚à¸—à¸©à¸„à¹ˆà¸° CO&OX à¸ˆà¸°à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸§à¸±à¸§à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™:\n${dialog}\nAI:`;
        const replyText = await askGemini(fullPrompt);
        userMemory[userId].push({ role: "bot", text: replyText });
        if (userMemory[userId].length > 10) userMemory[userId].shift();
        await reply(replyToken, replyText);
      }
    }
  }

  res.sendStatus(200);
});

// ========== Gemini Functions ==========
async function askGemini(prompt) {
  const res = await axios.post(
    "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
    {
      contents: [{ parts: [{ text: prompt }] }],
    },
    {
      headers: { "Content-Type": "application/json" },
      params: { key: process.env.GEMINI_API_KEY },
    }
  );
  return res.data.candidates?.[0]?.content?.parts?.[0]?.text || "âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸•à¸­à¸šà¹„à¸”à¹‰";
}

async function askGeminiWithImage(imagePath, promptText) {
  const base64Image = fs.readFileSync(imagePath, { encoding: "base64" });
  const res = await axios.post(
    "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
    {
      contents: [
        {
          parts: [
            {
              inlineData: {
                mimeType: "image/jpeg",
                data: base64Image,
              },
            },
            { text: promptText },
          ],
        },
      ],
    },
    {
      headers: { "Content-Type": "application/json" },
      params: { key: process.env.GEMINI_API_KEY },
    }
  );
  return res.data.candidates?.[0]?.content?.parts?.[0]?.text || "âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹„à¸”à¹‰";
}

// ========== LINE Message Functions ==========
async function reply(token, text) {
  await axios.post(
    "https://api.line.me/v2/bot/message/reply",
    {
      replyToken: token,
      messages: [{ type: "text", text }],
    },
    {
      headers: {
        Authorization: `Bearer ${CHANNEL_ACCESS_TOKEN}`,
        "Content-Type": "application/json",
      },
    }
  );
}

async function push(userId, text) {
  await axios.post(
    "https://api.line.me/v2/bot/message/push",
    {
      to: userId,
      messages: [{ type: "text", text }],
    },
    {
      headers: {
        Authorization: `Bearer ${CHANNEL_ACCESS_TOKEN}`,
        "Content-Type": "application/json",
      },
    }
  );
}

app.listen(3001, () => {
  console.log("ðŸš€ Server running on http://localhost:3001");
});
