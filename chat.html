<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üêÆ ‡∏´‡∏°‡∏≠‡∏ß‡∏±‡∏ß | ‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó‡πÇ‡∏£‡∏Ñ‡∏ß‡∏±‡∏ß</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
  <style>
    /* Reset & Base Styles */
    * {
      box-sizing: border-box; /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ semi-colon ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏© */
      font-family: 'Kanit', sans-serif;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden; /* Prevent body scrollbar */
    }

    /* Splash Screen */
    .splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #66bb6a; /* Green background */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000; /* Ensure it's on top */
      transition: opacity 0.5s ease-out; /* Smooth fade out */
    }

    .splash-screen.hidden {
        opacity: 0;
        visibility: hidden;
    }

    .splash-screen img {
      width: 350px; /* Size of the cow icon */
      height: 350px;
      animation: bounce 1s infinite alternate; /* Simple bounce animation */
    }

    .splash-screen h1 {
        color: white;
        font-size: 2.5rem;
        margin-top: 20px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    @keyframes bounce {
      0% { transform: translateY(0); }
      100% { transform: translateY(-10px); }
    }

    /* Chat Wrapper */
    .chat-wrapper {
      display: none;
      flex-direction: column;
      height: calc(var(--vh, 1vh) * 100); /* ‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å 100vh */
      width: 100%;
    }

    .chat-wrapper.show {
      display: flex;
    }

    /* Header */
    .header {
      background-color: #66bb6a;
      color: white;
      padding: 20px;
      font-size: 1.6rem;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: relative;
      z-index: 2;
    }

    /* Chat Box - Main message display area */
    .chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: #f9fbe7;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Chat Rows - Container for each message (user or bot) */
    .chat-row {
      display: flex;
      align-items: flex-start;
      max-width: 100%;
    }
    .chat-row.user {
      justify-content: flex-end;
    }
    .chat-row.bot {
      flex-direction: row;
    }

    /* Chat Bubbles - The actual message bubble */
    .chat-bubble {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.5;
      word-wrap: break-word;
      font-size: 0.95rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    }
    .chat-bubble.user {
      background-color: #c8e6c9;
      color: #333;
      border-bottom-right-radius: 4px;
    }
    .chat-bubble.bot {
      background-color: #e0f2f1;
      color: #333;
      border-bottom-left-radius: 4px;
      margin-left: 10px;
    }

    /* Avatar */
    .avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Chat Image within Bubble */
    .chat-image {
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      margin-top: 6px;
      display: block;
    }
    .chat-bubble.user .chat-image {
      margin-left: auto;
    }

    /* --- Form Input Area --- */
    form {
      position: relative;
      display: flex;
      padding: 12px 16px;
      border-top: 1px solid #eee;
      background: #f8f8f8;
      gap: 8px;
      align-items: center;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
      z-index: 1;
    }

    /* Input Wrapper for the text field and action icons */
    .input-wrapper {
      flex: 1;
      display: flex;
      flex-direction: row;
      align-items: center;
      border: 1px solid #ddd;
      border-radius: 25px;
      background: #fff;
      padding: 4px 8px;
      transition: border-color 0.2s, box-shadow 0.2s;
      position: relative;
    }
    .input-wrapper:focus-within {
      border-color: #4CAF50;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }

    /* Adjust input and preview layout when image is present */
    .input-wrapper.has-image {
        flex-direction: column;
        padding-bottom: 8px;
        align-items: flex-start;
    }

    input[type="text"] {
      flex-grow: 1;
      padding: 8px 10px;
      border: none;
      outline: none;
      font-size: 1rem;
      background: transparent;
      min-height: 24px;
      width: 100%;
    }

    /* Action Buttons (inside the input wrapper) */
    .action-buttons-group {
        display: flex;
        gap: 4px;
        order: -1;
        padding-right: 8px;
    }
    .input-wrapper.has-image .action-buttons-group {
        order: 1;
        width: 100%;
        justify-content: flex-start;
        padding-right: 0;
    }


    .action-btn {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 20px;
      padding: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
      border-radius: 50%;
    }
    .action-btn:hover {
      color: #4CAF50;
      background-color: rgba(0,0,0,0.05);
    }
    .action-btn.file-upload {
      color: #8bc34a;
    }
    .action-btn.camera-capture {
      color: #ff9800;
    }

    /* Send Button (outside the input wrapper) */
    .send-btn {
      background: none;
      border: none;
      color: #4CAF50;
      cursor: pointer;
      font-size: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s, transform 0.2s;
      padding: 8px;
    }
    .send-btn:hover {
      color: #45a049;
      transform: scale(1.1);
    }
    .send-btn:active {
      transform: scale(1.0);
    }
    /* --- End Modified Form Input Area --- */

    /* Hidden File Inputs */
    #imageInputFile, #imageInputCamera {
      display: none;
    }

    /* Image Preview Overlay - NOW INSIDE input-wrapper */
    .preview-overlay {
      display: none;
      flex-direction: row;
      align-items: center;
      padding: 8px;
      border-radius: 12px;
      background: #f0f0f0;
      margin-top: 4px;
      width: 100%;
      position: relative;
      box-shadow: inset 0 0 3px rgba(0,0,0,0.1);
    }
    .preview-overlay img {
      max-width: 60px;
      max-height: 60px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
    }
    .preview-overlay button {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #f44336;
      border: 1px solid white;
      color: white;
      font-size: 14px;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .preview-overlay p {
        margin: 0;
        padding-left: 10px;
        color: #555;
        font-size: 0.9rem;
    }

    /* Typing Indicator (for bot response pending) */
    .typing-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 10px;
      margin-top: 5px;
      padding: 8px 12px;
      background-color: #e0f2f1;
      border-radius: 18px;
      max-width: fit-content;
      font-size: 0.9rem;
      color: #555;
    }
    .typing-indicator span {
      animation: blink 1.2s infinite;
      font-size: 1.5em;
      line-height: 0;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="splash-screen" id="splashScreen">
    <img src="icon.png" alt="‡∏´‡∏°‡∏≠‡∏ß‡∏±‡∏ß‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô" />
    <h1>‡∏´‡∏°‡∏≠‡∏ß‡∏±‡∏ß</h1>
  </div>

  <div class="chat-wrapper" id="chatWrapper">
    <div class="header">üêÆ ‡∏´‡∏°‡∏≠‡∏ß‡∏±‡∏ß </div>
    <div class="chat-box" id="chatBox"></div>

    <form id="chatForm">
      <div class="input-wrapper" id="inputWrapper">
        <div class="action-buttons-group">
          <label for="imageInputFile" class="action-btn file-upload" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå">‚ûï</label>
          <input type="file" accept="image/*" id="imageInputFile" />

          <label for="imageInputCamera" class="action-btn camera-capture" title="‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏•‡πâ‡∏≠‡∏á">üì∏</label>
          <input type="file" accept="image/*" id="imageInputCamera" capture="environment" />
        </div>

        <div class="preview-overlay" id="previewOverlay">
          <img id="previewImage" alt="‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏†‡∏≤‡∏û" />
          <button type="button" onclick="clearPreview()" title="‡∏•‡∏ö‡∏†‡∏≤‡∏û">‚úñ</button>
        </div>

        <input type="text" id="userInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û..." autocomplete="off" />
      </div>
      <button type="submit" class="send-btn" title="‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°">‚û§</button>
    </form>
  </div>

  <script>
    const BACKEND_URL = 'https://your-app-name.herokuapp.com/api/chat';
   const TM_MODEL_URL = "https://teachablemachine.withgoogle.com/models/I_d2z8vuR/";


    const splashScreen = document.getElementById('splashScreen');
    const chatWrapper = document.getElementById('chatWrapper');
    const form = document.getElementById('chatForm');
    const chatBox = document.getElementById('chatBox');
    const input = document.getElementById('userInput');
    const imageInputFile = document.getElementById('imageInputFile');
    const imageInputCamera = document.getElementById('imageInputCamera');
    const inputWrapper = document.getElementById('inputWrapper');
    const previewOverlay = document.getElementById('previewOverlay');
    const previewImage = document.getElementById('previewImage');

    let pendingImageData = null;
    let pendingImageFile = null;
    const chatHistory = [];
    let typingIndicatorElement = null;
    let tmModel, webcam, isTMRunning = false;

    window.addEventListener('load', () => {
      setTimeout(showChatAfterSplash, 2000);
      loadTeachableMachine();
    });

    function showChatAfterSplash() {
      splashScreen.classList.add('hidden');
      setTimeout(() => {
        splashScreen.style.display = 'none';
        chatWrapper.classList.add('show');
        appendMessage('bot', {
          type: 'text',
          content: '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö **‡∏ú‡∏°‡∏´‡∏°‡∏≠‡∏ß‡∏±‡∏ß** ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ß‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?'
        });
      }, 500);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      const hasText = text.length > 0;
      const hasImage = !!pendingImageData;

      if (!hasText && !hasImage) return;
      if (hasText) appendMessage('user', { type: 'text', content: text });
      if (hasImage) appendMessage('user', { type: 'image', content: pendingImageData });

      input.value = '';
      clearPreview();
      showTypingIndicator();

      try {
        const requestData = {
          chatHistory,
          hasImage,
          imageData: hasImage && pendingImageData ? pendingImageData.split(',')[1] : null,
          imageMimeType: hasImage && pendingImageFile ? pendingImageFile.type : null,
          textInput: text
        };

        const response = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData)
        });

        const data = await response.json();
        hideTypingIndicator();

        if (response.ok) {
          const reply = data.reply;
          appendMessage('bot', { type: 'text', content: reply });
          if (hasText) chatHistory.push({ role: 'user', parts: [{ text }] });
          chatHistory.push({ role: 'model', parts: [{ text: reply }] });
        } else {
          appendMessage('bot', { type: 'text', content: data.error || '‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á' });
        }
      } catch (err) {
        hideTypingIndicator();
        appendMessage('bot', { type: 'text', content: '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ' });
      }
    });

    imageInputFile.addEventListener('change', (e) => handleImageSelection(e.target.files[0]));
    imageInputCamera.addEventListener('change', (e) => handleImageSelection(e.target.files[0]));

    function handleImageSelection(file) {
      if (!file || !file.type.startsWith('image/')) return;
      pendingImageFile = file;
      const reader = new FileReader();
      reader.onload = () => {
        pendingImageData = reader.result;
        previewImage.src = reader.result;
        previewOverlay.style.display = 'flex';
        inputWrapper.classList.add('has-image');
        input.placeholder = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...';
        input.focus();
      };
      reader.readAsDataURL(file);
    }

    function clearPreview() {
      previewOverlay.style.display = 'none';
      previewImage.src = '';
      pendingImageData = null;
      pendingImageFile = null;
      inputWrapper.classList.remove('has-image');
      input.placeholder = '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ß...';
      imageInputFile.value = '';
      imageInputCamera.value = '';
    }

    function appendMessage(sender, message) {
      const row = document.createElement('div');
      row.className = `chat-row ${sender}`;
      if (sender === 'bot') {
        const avatar = document.createElement('img');
        avatar.src = 'icon.png';
        avatar.alt = '‡∏´‡∏°‡∏≠‡∏ß‡∏±‡∏ß';
        avatar.className = 'avatar';
        row.appendChild(avatar);
      }
      const bubble = document.createElement('div');
      bubble.className = `chat-bubble ${sender}`;
      if (message.type === 'text') {
        bubble.innerHTML = formatText(message.content);
      } else if (message.type === 'image') {
        const img = document.createElement('img');
        img.src = message.content;
        img.className = 'chat-image';
        bubble.appendChild(img);
      }
      row.appendChild(bubble);
      chatBox.appendChild(row);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function formatText(text) {
      text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
      text = text.split('\n').map(line =>
        line.startsWith('- ') ? `<li>${line.substring(2)}</li>` : line
      ).join('\n');
      if (text.includes('<li>')) text = `<ul>${text}</ul>`;
      return text.replace(/\n/g, '<br>');
    }

    function showTypingIndicator() {
      if (typingIndicatorElement) hideTypingIndicator();
      const row = document.createElement('div');
      row.className = 'chat-row bot';
      const avatar = document.createElement('img');
      avatar.src = 'icon.png';
      avatar.alt = '‡∏´‡∏°‡∏≠‡∏ß‡∏±‡∏ß';
      avatar.className = 'avatar';
      row.appendChild(avatar);
      typingIndicatorElement = document.createElement('div');
      typingIndicatorElement.className = 'typing-indicator chat-bubble bot';
      typingIndicatorElement.innerHTML = '<span>.</span><span>.</span><span>.</span>';
      row.appendChild(typingIndicatorElement);
      chatBox.appendChild(row);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function hideTypingIndicator() {
      if (typingIndicatorElement?.parentNode) {
        const parentRow = typingIndicatorElement.closest('.chat-row');
        if (parentRow) chatBox.removeChild(parentRow);
        typingIndicatorElement = null;
      }
    }

    // Teachable Machine functions
    async function loadTeachableMachine() {
      const modelURL = TM_MODEL_URL + "model.json";
      const metadataURL = TM_MODEL_URL + "metadata.json";
      tmModel = await tmImage.load(modelURL, metadataURL);
      webcam = new tmImage.Webcam(200, 200, true);
      await webcam.setup();
      await webcam.play();
      const div = document.createElement('div');
      div.style.position = "fixed";
      div.style.right = "10px";
      div.style.bottom = "10px";
      div.style.border = "2px solid green";
      div.appendChild(webcam.canvas);
      document.body.appendChild(div);
      window.requestAnimationFrame(runPrediction);
    }

    async function runPrediction() {
      webcam.update();
      const predictions = await tmModel.predict(webcam.canvas);
      const best = predictions.reduce((a, b) => a.probability > b.probability ? a : b);
      if (best.probability > 0.95 && !isTMRunning) {
        isTMRunning = true;
        appendMessage('bot', { type: 'text', content: `‡∏ú‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ß‡πà‡∏≤: **${best.className}** ‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö` });
        chatHistory.push({ role: 'user', parts: [{ text: `‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û ${best.className}` }] });
        chatHistory.push({ role: 'model', parts: [{ text: `‡∏ú‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ß‡πà‡∏≤: ${best.className}` }] });
        setTimeout(() => isTMRunning = false, 5000);
      }
      window.requestAnimationFrame(runPrediction);
    }
  </script>
</body>
</html>
