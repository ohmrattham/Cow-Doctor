<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏ß‡∏±‡∏ß</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Kanit', sans-serif;
      margin: 0;
      background: #f0f4f8;
      color: #2d6a4f;
    }

    /* Loading Screen */
    #loadingScreen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: white;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #loadingIcon {
      width: 120px;
      animation: shake 0.6s infinite;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    header {
      background: #2d6a4f;
      color: white;
      padding: 1.2rem;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô */
    #logoutBtn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px;
      z-index: 1000;
    }
    #logoutBtn svg {
      display: block;
      stroke: #d62828;
      width: 28px;
      height: 28px;
    }
    #logoutBtn:hover svg {
      stroke: #ff0000;
    }

    main {
      max-width: 900px;
      margin: auto;
      padding: 1.5rem;
    }

    /* ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£ */
    .news-list .card {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: #edf6f9;
      border-left: 6px solid #2d6a4f;
      padding: 0.8rem 1rem;
      margin-bottom: 0.8rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .news-list .card:hover,
    .news-list .card:focus {
      background: #d1e7dd;
      outline: none;
    }
    .news-list .card img {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
    }
    .news-list .news-content p {
      margin: 0;
      font-weight: 600;
      color: #1b4332;
    }
    .news-list .news-content time {
      color: #555;
      font-size: 0.9rem;
    }

    /* Modal ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£ */
    #newsModal {
      display: none;
      position: fixed;
      z-index: 11000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }
    #newsModal .modal-content {
      background-color: #fff;
      margin: auto;
      padding: 1.5rem;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      max-height: 90vh;
      overflow-y: auto;
    }
    #newsModal .close {
      position: absolute;
      top: 12px;
      right: 16px;
      color: #333;
      font-size: 1.8rem;
      font-weight: bold;
      cursor: pointer;
    }
    #newsModal img {
      max-width: 100%;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    #newsModal h3 {
      margin-top: 0;
      color: #1b4332;
    }
    #newsModal p {
      white-space: pre-wrap;
      line-height: 1.4;
      color: #2d6a4f;
    }
    #newsModal time {
      color: #555;
      font-size: 0.9rem;
      display: block;
      margin-top: 0.6rem;
    }

    /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ß‡∏±‡∏ß */
    .cow-card {
      position: relative;
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      background: #fff;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      flex-wrap: wrap;
    }

    .cow-card img {
      width: 100px;
      height: 100px;
      border-radius: 10px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .cow-info {
      flex: 1 1 250px;
      min-width: 200px;
    }

    .cow-actions {
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  gap: 8px;
}

.cow-actions button {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 4px;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.3s;
}

.cow-actions button svg {
  stroke: #40916c;
  width: 18px;
  height: 18px;
}

.cow-actions button.delete svg {
  stroke: #d62828;
}

.cow-actions button:hover {
  background-color: rgba(66, 165, 245, 0.1);
}

.cow-actions button.delete:hover svg {
  stroke: #ff0000;
}


    /* ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô */
    .edit-button {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #40916c;
      border: none;
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 18px;
      line-height: 28px;
      text-align: center;
      padding: 0;
      z-index: 10;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ß ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡∏ß‡∏á‡∏Å‡∏•‡∏° */
    #addCowBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: transparent;
      color: black;
      border: none;
      font-size: 2.5rem;
      cursor: pointer;
      z-index: 20;
      padding: 0;
      line-height: 1;
      user-select: none;
      transition: color 0.3s;
    }
    #addCowBtn:hover {
      color: #2d6a4f;
    }

    /* Modal ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ß */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: #fff;
      margin: auto;
      padding: 1.5rem;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .close {
      position: absolute;
      top: 12px;
      right: 16px;
      color: #333;
      font-size: 1.8rem;
      font-weight: bold;
      cursor: pointer;
    }

    #modalCowForm input,
    #modalCowForm textarea,
    #modalCowForm button {
      font-family: 'Kanit', sans-serif;
      font-size: 1rem;
      padding: 0.7rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 0.8rem;
    }

    #modalCowForm textarea {
      resize: vertical;
    }

    #modalCowForm button {
      background: #2d6a4f;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
      transition: background 0.3s;
    }

    #modalCowForm button:hover {
      background: #1b4332;
    }

    #chatBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  font-size: 2.2rem;
  background: #2d6a4f;
  color: white;
  padding: 12px 16px;
  border-radius: 50%;
  text-decoration: none;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  z-index: 2000;
  transition: background 0.3s, transform 0.2s;
}
#chatBtn:hover {
  background: #1b4332;
  transform: scale(1.1);
}

  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingScreen">
    <img src="icon.png" alt="Loading..." id="loadingIcon" />
  </div>

  <header>
    <h1>üêÆ ‡∏´‡∏°‡∏≠‡∏ß‡∏±‡∏ß</h1>
    <p id="userName">...</p>
  </header>

  <button id="logoutBtn" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö" aria-label="Logout">
    <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô logout -->
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="#d62828" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
      <polyline points="16 17 21 12 16 7"/>
      <line x1="21" y1="12" x2="9" y2="12"/>
    </svg>
  </button>

  <main>
    <section class="news-list" aria-label="‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£">
      <h2>üì∞ ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</h2>
      <div class="card" data-news-index="0" tabindex="0" role="button" aria-pressed="false" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£ ‡∏õ‡∏®‡∏∏‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÇ‡∏£‡∏Ñ‡∏õ‡∏≤‡∏Å‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏õ‡∏∑‡πà‡∏≠‡∏¢">
        <img src="https://images.unsplash.com/photo-1574169208507-8437616489a3?auto=format&fit=crop&w=80&q=80" alt="‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏®‡∏∏‡∏™‡∏±‡∏ï‡∏ß‡πå" />
        <div class="news-content">
          <p>üì¢ ‡∏õ‡∏®‡∏∏‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÇ‡∏£‡∏Ñ‡∏õ‡∏≤‡∏Å‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏õ‡∏∑‡πà‡∏≠‡∏¢</p>
          <time datetime="2025-07-01T09:30:00">1 ‡∏Å.‡∏Ñ. 2025 09:30</time>
        </div>
      </div>
      <div class="card" data-news-index="1" tabindex="0" role="button" aria-pressed="false" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏ü‡∏£‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ß‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô">
        <img src="https://images.unsplash.com/photo-1602524811013-3a0f4a592d0b?auto=format&fit=crop&w=80&q=80" alt="‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏ß‡∏±‡∏ß" />
        <div class="news-content">
          <p>üíâ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏ü‡∏£‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ß‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô</p>
          <time datetime="2025-07-03T14:00:00">3 ‡∏Å.‡∏Ñ. 2025 14:00</time>
        </div>
      </div>
    </section>

    <section class="cow-list" style="position: relative;" aria-label="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ß">
      <h2>üìÉ ‡∏ß‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÅ‡∏•
        <button id="addCowBtn" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ß" aria-label="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ß">Ôºã</button>
      </h2>
      <div id="cowCards" aria-live="polite" aria-atomic="true">
        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ß</p>
      </div>
    </section>
  </main>

<a href="chat.html" id="chatBtn" title="‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡∏´‡∏°‡∏≠‡∏ß‡∏±‡∏ß" aria-label="‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡∏´‡∏°‡∏≠‡∏ß‡∏±‡∏ß">
  üí¨
</a>

  <!-- Modal ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£ -->
  <div id="newsModal" role="dialog" aria-modal="true" aria-labelledby="newsModalTitle" aria-describedby="newsModalDesc" tabindex="-1">
    <div class="modal-content">
      <span class="close" id="newsModalClose" tabindex="0" role="button" aria-label="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á">&times;</span>
      <img id="newsModalImg" src="" alt="" />
      <h3 id="newsModalTitle"></h3>
      <p id="newsModalDesc"></p>
      <time id="newsModalTime"></time>
    </div>
  </div>

  <!-- Modal ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ß -->
  <div id="cowModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="cowModalTitle" tabindex="-1">
    <div class="modal-content">
      <span id="closeModal" class="close" tabindex="0" role="button" aria-label="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á">&times;</span>
      <h2 id="cowModalTitle">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ß</h2>
      <form id="modalCowForm">
        <input type="text" id="modalCowName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ß" required aria-required="true" />
        <input type="date" id="modalCowBirthday" max="" placeholder="‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î" />
        <input type="number" id="modalCowWeight" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)" />
        <input type="text" id="modalCowVaccine" placeholder="‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î" />
        <input type="file" id="modalCowImage" accept="image/*" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ß‡∏±‡∏ß" />
        <textarea id="modalCowDetail" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏Å‡∏≤‡∏£" required aria-required="true"></textarea>
        <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ß</button>
      </form>
    </div>
  </div>

  <script type="module">
    import {
      auth, db, storage, collection, addDoc, query, where, getDocs, serverTimestamp,
      onAuthStateChanged, signOut, doc, deleteDoc, getDoc, updateDoc
    } from './firebase.js';

    import { ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js';

    const userNameEl = document.getElementById('userName');
    const logoutBtn = document.getElementById('logoutBtn');
    const cowCards = document.getElementById('cowCards');
    const cowModal = document.getElementById('cowModal');
    const closeModalBtn = document.getElementById('closeModal');
    const modalCowForm = document.getElementById('modalCowForm');
    const addCowBtn = document.getElementById('addCowBtn');
    const loadingScreen = document.getElementById('loadingScreen');

    let user = null;
    let currentEditId = null;

    // ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
    const newsData = [
      {
        title: "üì¢ ‡∏õ‡∏®‡∏∏‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÇ‡∏£‡∏Ñ‡∏õ‡∏≤‡∏Å‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏õ‡∏∑‡πà‡∏≠‡∏¢",
        content: `‡∏õ‡∏®‡∏∏‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÇ‡∏£‡∏Ñ‡∏õ‡∏≤‡∏Å‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏õ‡∏∑‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏ù‡∏π‡∏á‡∏ß‡∏±‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏®‡∏∏‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÉ‡∏Å‡∏•‡πâ‡∏ö‡πâ‡∏≤‡∏ô`,
        image: "https://images.unsplash.com/photo-1574169208507-8437616489a3?auto=format&fit=crop&w=600&q=80",
        datetime: "2025-07-01T09:30:00"
      },
      {
        title: "üíâ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏ü‡∏£‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ß‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô",
        content: `‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏®‡∏∏‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏à‡∏±‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏ü‡∏£‡∏µ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ß‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ß‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏î‡∏µ ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏®‡∏∏‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏≠‡∏≥‡πÄ‡∏†‡∏≠`,
        image: "https://images.unsplash.com/photo-1602524811013-3a0f4a592d0b?auto=format&fit=crop&w=600&q=80",
        datetime: "2025-07-03T14:00:00"
      }
    ];

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î max ‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î = ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    document.getElementById('modalCowBirthday').max = new Date().toISOString().split('T')[0];

    onAuthStateChanged(auth, async (u) => {
      if (!u) {
        window.location.href = 'index.html';
        return;
      }
      user = u;
      userNameEl.textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡∏Ñ‡∏∏‡∏ì ${u.displayName || u.email}`;
      loadingScreen.style.display = 'none';
      await loadCows();
    });

    logoutBtn.onclick = () => {
      signOut(auth).then(() => {
        window.location.href = 'index.html';
      });
    };

    async function loadCows() {
      cowCards.innerHTML = '<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ß...</p>';
      try {
        const q = query(collection(db, "cows"), where("uid", "==", user.uid));
        const querySnapshot = await getDocs(q);
        if (querySnapshot.empty) {
          cowCards.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ß</p>';
          return;
        }
        cowCards.innerHTML = '';
        querySnapshot.forEach(docSnap => {
          const cow = docSnap.data();
          const id = docSnap.id;
          const card = createCowCard(cow, id);
          cowCards.appendChild(card);
        });
      } catch (error) {
        cowCards.innerHTML = `<p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}</p>`;
      }
    }

    function createCowCard(cow, id) {
  const div = document.createElement('div');
  div.classList.add('cow-card');
  div.setAttribute('data-id', id);
  div.setAttribute('tabindex', '0');
  div.setAttribute('aria-label', `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ß‡∏ä‡∏∑‡πà‡∏≠ ${cow.name}`);

  const img = document.createElement('img');
  img.src = cow.imageUrl || 'https://via.placeholder.com/100?text=No+Image';
  img.alt = `‡∏£‡∏π‡∏õ‡∏ß‡∏±‡∏ß ${cow.name}`;

  const infoDiv = document.createElement('div');
  infoDiv.className = 'cow-info';
  infoDiv.innerHTML = `
    <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${cow.name}</p>
    <p><strong>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:</strong> ${cow.birthday || '-'}</p>
    <p><strong>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å:</strong> ${cow.weight || '-'} ‡∏Å‡∏Å.</p>
    <p><strong>‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${cow.vaccine || '-'}</p>
    <p><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong> ${cow.detail || '-'}</p>
  `;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á div ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
  const actionsDiv = document.createElement('div');
  actionsDiv.className = 'cow-actions';

  // ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏î‡∏¥‡∏ô‡∏™‡∏≠)
  const editBtn = document.createElement('button');
  editBtn.setAttribute('aria-label', `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ß‡∏ä‡∏∑‡πà‡∏≠ ${cow.name}`);
  editBtn.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="#40916c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
      <path d="M12 20h9" />
      <path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z" />
    </svg>
  `;
  editBtn.onclick = () => openEditModal(id);

  // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞)
  const deleteBtn = document.createElement('button');
  deleteBtn.classList.add('delete');
  deleteBtn.setAttribute('aria-label', `‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ß‡∏ä‡∏∑‡πà‡∏≠ ${cow.name}`);
  deleteBtn.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="#d62828" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
      <polyline points="3 6 5 6 21 6" />
      <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
      <path d="M10 11v6" />
      <path d="M14 11v6" />
      <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" />
    </svg>
  `;
  deleteBtn.onclick = () => confirmDeleteCow(id, cow.name);

  actionsDiv.appendChild(editBtn);
  actionsDiv.appendChild(deleteBtn);

  div.appendChild(img);
  div.appendChild(infoDiv);
  div.appendChild(actionsDiv);

  return div;
}


    addCowBtn.onclick = () => {
      currentEditId = null;
      openCowModal();
    };

    closeModalBtn.onclick = () => {
      closeCowModal();
    };

    window.onclick = function(event) {
      if (event.target === cowModal) {
        closeCowModal();
      }
      if (event.target === newsModal) {
        closeNewsModal();
      }
    };

    async function openEditModal(id) {
      try {
        const docSnap = await getDoc(doc(db, "cows", id));
        if (docSnap.exists()) {
          const cow = docSnap.data();
          currentEditId = id;
          openCowModal(cow);
        } else {
          alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ß‡∏ô‡∏µ‡πâ');
        }
      } catch (error) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
      }
    }

    function openCowModal(cow = null) {
      if (cow) {
        document.getElementById('modalCowName').value = cow.name || '';
        document.getElementById('modalCowBirthday').value = cow.birthday || '';
        document.getElementById('modalCowWeight').value = cow.weight || '';
        document.getElementById('modalCowVaccine').value = cow.vaccine || '';
        document.getElementById('modalCowDetail').value = cow.detail || '';
      } else {
        modalCowForm.reset();
      }
      cowModal.style.display = 'flex';
      document.getElementById('modalCowName').focus();
    }

    function closeCowModal() {
      cowModal.style.display = 'none';
      currentEditId = null;
    }

    modalCowForm.onsubmit = async (e) => {
      e.preventDefault();

      const name = document.getElementById('modalCowName').value.trim();
      const birthday = document.getElementById('modalCowBirthday').value;
      const weight = parseFloat(document.getElementById('modalCowWeight').value) || '';
      const vaccine = document.getElementById('modalCowVaccine').value.trim();
      const detail = document.getElementById('modalCowDetail').value.trim();

      if (!name || !detail) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏±‡∏ß');
        return;
      }

      try {
        let imageUrl = '';

        const inputFile = document.getElementById('modalCowImage');
        if (inputFile.files.length > 0) {
          const file = inputFile.files[0];
          const storageRef = ref(storage, `cows/${user.uid}/${Date.now()}_${file.name}`);
          // ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
          await uploadBytes(storageRef, file);
          // ‡∏î‡∏∂‡∏á URL
          imageUrl = await getDownloadURL(storageRef);
        }

        const cowData = {
          uid: user.uid,
          name,
          birthday,
          weight,
          vaccine,
          detail,
          updatedAt: serverTimestamp(),
        };

        if (imageUrl) {
          cowData.imageUrl = imageUrl;
        }

        if (currentEditId) {
          await updateDoc(doc(db, "cows", currentEditId), cowData);
          alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        } else {
          cowData.createdAt = serverTimestamp();
          await addDoc(collection(db, "cows"), cowData);
          alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå input ‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        inputFile.value = '';
        closeCowModal();
        await loadCows();

      } catch (error) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
      }
    };

    async function confirmDeleteCow(id, name) {
      if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ß‡∏ä‡∏∑‡πà‡∏≠ "${name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
        try {
          await deleteDoc(doc(db, "cows", id));
          alert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
          await loadCows();
        } catch (error) {
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
        }
      }
    }

    // ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£ modal
    const newsModal = document.getElementById('newsModal');
    const newsModalClose = document.getElementById('newsModalClose');
    const newsModalImg = document.getElementById('newsModalImg');
    const newsModalTitle = document.getElementById('newsModalTitle');
    const newsModalDesc = document.getElementById('newsModalDesc');
    const newsModalTime = document.getElementById('newsModalTime');

    const newsCards = document.querySelectorAll('.news-list .card');
    newsCards.forEach(card => {
      card.addEventListener('click', openNewsModal);
      card.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openNewsModal.call(card);
        }
      });
    });

    function openNewsModal() {
      const index = parseInt(this.dataset.newsIndex);
      const news = newsData[index];
      if (!news) return;

      newsModalImg.src = news.image;
      newsModalImg.alt = news.title;
      newsModalTitle.textContent = news.title;
      newsModalDesc.textContent = news.content;
      newsModalTime.textContent = new Date(news.datetime).toLocaleString('th-TH', {
        dateStyle: 'medium',
        timeStyle: 'short'
      });

      newsModal.style.display = 'flex';
      newsModal.focus();
    }

    newsModalClose.onclick = closeNewsModal;

    function closeNewsModal() {
      newsModal.style.display = 'none';
    }
  </script>
</body>
</html>